<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Ciki-Chu Lung">
<meta name="author" content="Chu Lung">
<meta content="Ciki,Chu Lung's wiki" name="keywords">
<title>Ciki-Chu Lung's wiki</title>
<link rel="shortcut icon" href="//chulung.github.io/statics/blog/images/favicon.ico"	type="image/x-icon" />
<link rel="stylesheet"
	href="https://cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css">
 <link href="https://static.chulung.com/statics/ciki/css/ciki.css" rel="stylesheet"/>
</head>
<div class="container">
	<div class="row">
		<div class="page-header"><h2><a href="/">Ciki</a> » <a href="/#database">database</a> » 其他问题&坑</h2>
		<div class="panel  panel-primary">
		  <div class="panel-body">
		 		<h1>异常问题</h1>
<h2>事务</h2>
<ul>
  <li>事务导致读写分离失败问题</li>
</ul>
<p>在测试时某保存操作时一直提示保存失败 查看服务器日志发现sqlException</p>
<pre><code> The MySQL server is running with the --read-only option so it cannot execute this statement
</code></pre>
<p>也就是说我们的保存操作执行到了读库上面</p>
<p>前一阵子的确上过一个读写分离的功能，查询操作走读库，修改操作才会找主库，仔细排查代码逻辑，确认逻辑没错</p>
<p>同事突然意识到，我们的保存操作是一个事务，在整个事务中，会先执行查询操作，再执行写操作，因为单个事务中 维持的connection只会有一个，因此写操作会在之前查询操作的同一connection上执行，而我们的查询操作走的是 读库，因此抛出sqlException。 这个读写分离问题估计在其他任何先执行读操作，再执行写操作的事务中会抛出，因此我们当天回滚了读写分离功能，</p>
		  </div>
		  </div>
	</div>
</div>
</html>
